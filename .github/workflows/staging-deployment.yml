name: Deploy to Staging

on:
  workflow_run:
    workflows: ["Backend Tests"]
    types:
      - completed
    branches: [develop]
  
  # Manual trigger option
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging

jobs:
  deploy-staging:
    name: Deploy to Staging Environment
    runs-on: ubuntu-latest
    
    # Only run if tests passed
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    environment:
      name: staging
      url: ${{ steps.deploy.outputs.url }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: develop
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        cache: 'npm'
    
    - name: Install backend dependencies
      working-directory: ./backend
      run: npm ci --production
    
    - name: Install frontend dependencies
      working-directory: ./frontend
      run: npm ci
    
    - name: Build frontend
      working-directory: ./frontend
      run: npm run build
      env:
        VITE_API_URL: ${{ secrets.STAGING_API_URL }}
    
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ secrets.AWS_REGION }}
      continue-on-error: true
    
    - name: Deploy to AWS EC2 (Option 1)
      id: deploy-ec2
      if: ${{ secrets.AWS_ACCESS_KEY_ID != '' }}
      run: |
        # Create deployment package
        tar -czf deployment.tar.gz backend/ frontend/dist/
        
        # Upload to S3
        aws s3 cp deployment.tar.gz s3://${{ secrets.STAGING_S3_BUCKET }}/deployments/$(date +%Y%m%d-%H%M%S).tar.gz
        
        # Deploy using AWS CodeDeploy
        aws deploy create-deployment \
          --application-name IDURAR-ERP-CRM \
          --deployment-group-name Staging-DeploymentGroup \
          --s3-location bucket=${{ secrets.STAGING_S3_BUCKET }},key=deployments/$(date +%Y%m%d-%H%M%S).tar.gz,bundleType=tgz \
          --description "Staging deployment from commit ${{ github.sha }}"
      continue-on-error: true
    
    - name: Deploy to Azure (Option 2)
      if: ${{ secrets.AZURE_CREDENTIALS != '' }}
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ secrets.AZURE_WEBAPP_NAME }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        package: .
      continue-on-error: true
    
    - name: Deploy using SSH (Option 3 - Manual Server)
      if: ${{ secrets.STAGING_SSH_HOST != '' }}
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.STAGING_SSH_HOST }}
        username: ${{ secrets.STAGING_SSH_USER }}
        key: ${{ secrets.STAGING_SSH_KEY }}
        port: ${{ secrets.STAGING_SSH_PORT || 22 }}
        script: |
          cd /var/www/idurar-staging
          git pull origin develop
          cd backend
          npm ci --production
          pm2 restart idurar-staging-backend
          cd ../frontend
          npm ci
          npm run build
          pm2 restart idurar-staging-frontend
      continue-on-error: true
    
    - name: Run smoke tests on staging
      run: |
        echo "Waiting for staging environment to be ready..."
        sleep 30
        
        # Health check
        curl -f ${{ secrets.STAGING_API_URL }}/api/health || exit 1
        
        # Basic API test
        curl -f ${{ secrets.STAGING_API_URL }}/api/ping || exit 1
      continue-on-error: true
    
    - name: Run integration tests on staging
      working-directory: ./backend
      run: |
        npm ci
        npx jest tests/integration/ --testTimeout=30000
      env:
        DATABASE: ${{ secrets.STAGING_DATABASE_URL }}
        JWT_SECRET: ${{ secrets.STAGING_JWT_SECRET }}
        API_URL: ${{ secrets.STAGING_API_URL }}
      continue-on-error: true
    
    - name: Notify deployment status
      if: always()
      uses: 8398a7/action-slack@v3
      with:
        status: ${{ job.status }}
        text: |
          Staging Deployment ${{ job.status }}
          Commit: ${{ github.sha }}
          Author: ${{ github.actor }}
          URL: ${{ secrets.STAGING_API_URL }}
        webhook_url: ${{ secrets.SLACK_WEBHOOK }}
      continue-on-error: true
    
    - name: Create deployment record
      if: success()
      run: |
        echo "‚úÖ Staging deployment successful!"
        echo "Environment: staging"
        echo "Commit: ${{ github.sha }}"
        echo "Deployed at: $(date)"
        echo "URL: ${{ secrets.STAGING_API_URL }}"
    
    - name: Deployment failed
      if: failure()
      run: |
        echo "‚ùå Staging deployment failed!"
        echo "Check logs for details"
        exit 1

  exploratory-testing:
    name: Manual Exploratory Testing
    runs-on: ubuntu-latest
    needs: deploy-staging
    if: success()
    
    steps:
    - name: Wait for manual testing
      run: |
        echo "üß™ Staging environment is ready for manual testing"
        echo "URL: ${{ secrets.STAGING_API_URL }}"
        echo ""
        echo "Please perform the following manual tests:"
        echo "1. Login functionality"
        echo "2. Client CRUD operations"
        echo "3. Invoice generation and download"
        echo "4. Payment processing"
        echo "5. Dashboard loading and data display"
        echo "6. Settings management"
        echo ""
        echo "Once validated, approve production deployment in GitHub Actions"
